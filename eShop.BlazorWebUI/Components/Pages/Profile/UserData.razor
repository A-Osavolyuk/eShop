@page "/profile/user-data"

@inject IDialogService DialogService
@inject IAuthenticationService AuthenticationService
@inject ITokenProvider TokenProvider

<PageTitle>User Data</PageTitle>

<AuthorizeView Context="authContext">
    <Authorized>
        <MudGrid>
            <MudItem xs="9">
                <MudPaper Outlined Class="pa-3">
                    <MudGrid>
                        <MudItem xs="2">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> First Name </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="10">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> @(string.IsNullOrEmpty(model.FirstName) ? "None" : model.FirstName) </MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    <MudGrid Class="mt-1">
                        <MudItem xs="2">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> Last Name </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="10">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> @(string.IsNullOrEmpty(model.LastName) ? "None" : model.LastName) </MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    <MudGrid Class="mt-1">
                        <MudItem xs="2">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> Middle Name </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="10">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> @(string.IsNullOrEmpty(model.MiddleName) ? "None" : model.MiddleName) </MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    <MudGrid Class="mt-1">
                        <MudItem xs="2">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> Phone Number </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="4">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> @(string.IsNullOrEmpty(model.PhoneNumber) ? "None" : model.PhoneNumber) </MudText>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="2">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> Email </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="4">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> @(string.IsNullOrEmpty(model.Email) ? "None" : model.Email) </MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    <MudGrid Class="mt-1">
                        <MudItem xs="2">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> Date of Birth </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="4">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> @(model.DateOfBirth) </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="2">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> Gender </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="4">
                            <MudPaper Outlined Class="pa-3">
                                <MudText Typo="Typo.h6"> @(string.IsNullOrEmpty(model.Gender) ? "None" : model.Gender) </MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    <MudGrid>
                        <MudItem xs="12">
                            <MudButton ButtonType="ButtonType.Button" Variant="Variant.Filled" Color="Color.Primary"
                                       Size="Size.Large" StartIcon="@Icons.Material.Filled.ChangeCircle" OnClick="ShowChangeDataForm">
                                Change personal data
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>
            <MudItem xs="3">
                <ProfileNavigation IsUserDataPage />
            </MudItem>
        </MudGrid>
    </Authorized>
</AuthorizeView>



@code {
    [CascadingParameter]
    public Task<AuthenticationState> Context { get; set; }
    private PersonalDataDto model { get; set; } = new();
    private bool ShowDialog { get; set; } = false; 

    override protected async Task OnInitializedAsync()
    {
        var state = await Context;
        var result = await AuthenticationService.
            GetPersonalDataAsync(state.User.Claims.FirstOrDefault(x => x.Type == CustomClaimTypes.Id).Value);

        if (result.IsSucceeded)
        {
            model = JsonConvert.DeserializeObject<PersonalDataDto>(result.Result!.ToString()!)!;
        }
    }

    private void ShowChangeDataForm()
    {
        DialogService.Show<ChangePersonalInfoDialog>("Change personal data", new DialogOptions()
            {
                DisableBackdropClick = true,
                ClassBackground = "blured",
            });
    }

}
