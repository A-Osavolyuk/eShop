@page "/products/create-product"

@using eShop.Application.Validation.Products
@using eShop.Infrastructure.StateContainers
@using LanguageExt.Pipes
@using CreateProductRequest = Domain.Requests.Product.CreateProductRequest

@inherits PageBase

@inject IProductService ProductService
@inject CreateProductValidator Validator
@inject InputImagesStateContainer InputImagesStateContainer

<Title Text="Create product"></Title>

<MudGrid Justify="Justify.Center">
    <MudItem xs="8">
        <MudPaper Outlined Class="pa-5">
            <MudForm @ref="form" Model="Model" Validation="Validator.ValidateValue">
                <MudGrid>
                    <MudItem xs="4">
                        <ImagesInput Model="Model"/>
                    </MudItem>
                    <MudItem xs="8">
                        <MudText Typo="Typo.h5">Main properties</MudText>
                        <MudGrid Justify="Justify.Center">
                            @* --- Main properties --- *@
                            <MudItem xs="12">
                                @* --- Name --- *@
                                <MudTextField
                                    Variant="Variant.Outlined"
                                    Immediate
                                    AutoGrow
                                    Label="Name"
                                    For="(() => Model.Name)"
                                    @bind-Value="Model.Name"
                                    MaxLength="100"
                                    Counter="100"
                                    InputType="InputType.Text"
                                    Placeholder="Enter name...">
                                </MudTextField>
                                @* --- Description --- *@
                                <MudTextField
                                    Variant="Variant.Outlined"
                                    Immediate
                                    AutoGrow
                                    Label="Description"
                                    For="(() => Model.Description)"
                                    @bind-Value="Model.Description"
                                    MaxLength="3000"
                                    Counter="3000"
                                    Lines="5"
                                    InputType="InputType.Text"
                                    Placeholder="Enter description...">
                                </MudTextField>
                                @* --- Price fields --- *@
                                <MudGrid Justify="Justify.Center">

                                    <MudItem xs="6">
                                        <MudNumericField
                                            For="(() => Model.Price)"
                                            Immediate
                                            @bind-Value="Model.Price"
                                            Step="0.1m"
                                            Max="100000"
                                            Min="0"
                                            Variant="Variant.Outlined"
                                            Label="Price">
                                        </MudNumericField>
                                    </MudItem>
                                    <MudItem xs="6">

                                        <MudSelect
                                            Variant="Variant.Outlined"
                                            Immediate
                                            @bind-Value="Model.Currency"
                                            For="() => Model.Currency"
                                            Label="Currency">
                                            <MudSelectItem Value="Currency.None" Disabled>None</MudSelectItem>
                                            @foreach (var currency in GetCurrencies())
                                            {
                                                <MudSelectItem Value="Enum.Parse<Currency>(currency)">@currency</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudItem>

                                </MudGrid>
                                @* --- Product Type --- *@
                                <MudSelect
                                    Variant="Variant.Outlined"
                                    For="() => Model.ProductType"
                                    @bind-Value="Model.ProductType"
                                    Immediate
                                    Label="Type">
                                    <MudSelectItem Value="ProductTypes.None" Disabled>None</MudSelectItem>
                                    @foreach (var type in GetTypes())
                                    {
                                        <MudSelectItem Value="@(Enum.Parse<ProductTypes>(type))">@type</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            @* --- Additional properties ---  *@
                            <MudItem xs="12">
                                @if (Model.ProductType != ProductTypes.None)
                                {
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.h5">Additional properties</MudText>
                                    </MudItem>

                                    <MudItem xs="12">
                                        @switch (Model.ProductType)
                                        {
                                            case ProductTypes.Shoes:
                                                <ShoesProperties Model="Model"/>
                                                break;
                                            case ProductTypes.Clothing:
                                                <ClothingProperties Model="Model"/>
                                                break;
                                            case ProductTypes.Accessories:
                                                break;
                                        }
                                    </MudItem>
                                }
                            </MudItem>
                            @* --- Navigation panel --- *@
                            <MudItem xs="12">
                                <MudButton
                                    Variant="Variant.Filled"
                                    Color="Color.Success"
                                    ButtonType="ButtonType.Button"
                                    StartIcon="@Icons.Material.Filled.Create"
                                    OnClick="OnSubmit">
                                    Submit
                                </MudButton>
                                <MudButton
                                    Variant="Variant.Filled"
                                    Color="Color.Error"
                                    ButtonType="ButtonType.Button"
                                    StartIcon="@Icons.Material.Filled.Delete"
                                    OnClick="ResetForm">
                                    Reset
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private MudForm form = new();
    private CreateProductRequest Model { get; set; } = new();

    #region Private methods

    private async Task OnSubmit()
    {
        await form.Validate();
    }

    private List<string> GetCurrencies()
    {
        return Enum.GetNames<Currency>()
            .Where(x => x != Currency.None.ToString())
            .ToList();
    }

    private List<string> GetTypes()
    {
        return Enum.GetNames<ProductTypes>()
            .Where(x => x != ProductTypes.None.ToString())
            .ToList();
    }

    private void ResetForm()
    {
        form.ResetValidation();
        Model = new();
        InputImagesStateContainer.OnClearImages();
        StateHasChanged();
    }

    #endregion

}