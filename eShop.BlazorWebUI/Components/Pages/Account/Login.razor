@page "/account/login"
@using eShop.Domain.DTOs
@using eShop.Domain.DTOs.Responses
@using eShop.Infrastructure.Account
@using Newtonsoft.Json

@inject ISnackbar Snackbar
@inject NavigationManager navigationManager
@inject IAuthenticationService authenticationService
@inject AuthenticationStateProvider authenticationStateProvider
@inject IValidator<LoginRequestDto> validator

<PageTitle>Login</PageTitle>

<MudGrid Justify="Justify.Center">
    <MudItem xs="4">
        <MudPaper Outlined Style="margin-top: 30%;" Class="pa-3">
            <EditForm FormName="login-form" Model="loginRequest" OnValidSubmit="LoginClick">
                <FluentValidationValidator Validator="validator"/>

                <MudText Align="Align.Center" Typo="Typo.h4">Log In</MudText>
                <MudTextField @bind-Value="loginRequest.Email" For="(() => loginRequest.Email)" 
                    InputType="InputType.Email" Label="Email" Immediate Variant="Variant.Outlined"/>
                <MudTextField @bind-Value="loginRequest.Password" For="(() => loginRequest.Password)" 
                    Label="Password" InputType="InputType.Password" Immediate Variant="Variant.Outlined"/>

                <MudGrid Justify="Justify.Center">
                    <MudItem xs="8">
                        <MudButton ButtonType="ButtonType.Submit" StartIcon="@Icons.Material.Filled.Login"
                                   Variant="Variant.Filled" Color="Color.Primary" Class="mt-3" FullWidth>
                            Log In
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudPaper>
        <MudPaper Outlined Class="mt-3 pa-3">
            <MudText Align="Align.Center">
                Do not have an account?
                <MudLink Href="account/register">Register</MudLink>
            </MudText>
        </MudPaper>
        <MudPaper Outlined Class="mt-3 pa-3">
            <MudText Align="Align.Center">
                Forget your password?
                <MudLink Href="account/reset-password">Reset password</MudLink>
            </MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [SupplyParameterFromForm] private LoginRequestDto loginRequest { get; set; } = new();

    private async Task LoginClick()
    {
        var result = await authenticationService.LoginAsync(loginRequest);

        if (result.IsSucceeded)
        {
            var data = JsonConvert.DeserializeObject<LoginResponseDto>(result.Result!.ToString()!);
            (authenticationStateProvider as ApplicationAuthenticationStateProvider)!.UpdateAuthenticationState(data!.Token);
            navigationManager.NavigateTo("/");
            Snackbar.Add(result.ResultMessage, MudBlazor.Severity.Success);
        }
        else 
            Snackbar.Add(result.ErrorMessage, MudBlazor.Severity.Error);
    }
}
